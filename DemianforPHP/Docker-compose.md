[Docker](#Docker)
[Команды](#Команды)
[Docker-Compose](#Docker-compose)
### Docker

**Контейнер** - завёрнутое приложение со всеми прикладными образами.

**Образ** - программные компоненты, которые используются при работе пиложения (postgress, php-fpm, redis, ...).

#### Команды:
- Стартует контейнер:
```
docker start <name/id>
```

- Ставит контейнер на паузу:
```
docker pause <name/id>
```

- Останавливает контейнер:
```
docker stop <name/id>
```

- Выводит информацию о существующих контейнерах:
```
docker info
```

- Выводит помощь:
```
docker help
```

Выводит справку о команде:
```
docker <команда> -help
```

----
#### Сбор Dockerfile
В проекте, в нужном месте необходимо создать Dockerfile для описания образа.
Команды внутри:
```Dockerfile
FROM php:8.3-fpm-alpine3.19 //какой образ использовать

COPY ./app/src ./src //из какой папки брать, в какую папку в образе всё записывать

EXPOSE 80 // локальный порт, на котором всё будет работать

WORKDIR var/www/html //рабочая директория в образе

RUN //compiler, который выполняется 1 раз при создании образа

CMD // выполняется каждый раз при запуске контейнера
```

В RUN кроме основного выполняющего файла можно указать также установку необходимых пакетов.
Например:
```Dockerfile
RUN install-php-extensions \  
    intl \  
    opcache \  
    pdo_pgsql \  
    uuid \  
    mongodb \  
    gd \  
    uopz \  
 > /dev/null  
RUN rm /usr/bin/install-php-extensions
```

`rm` = remove;

Для запуска образа используем:
`docker build -t <имя образа в нижнем регистре> <расположение Dockerfile>`

`-t` - отвечает за title для создания образа с заголовком

`docker run -p 8080:80 -d <имя образа>`

`-p` - отвечает за port для запуска образа. 80 - локальный порт.

`-d` - отвечает за запуск в фоновом режиме.

----
В docker-hub есть информация по настройке большинства стандартных образов.

----

### Docker-Compose

Инструмент, который позволяет определять и запускать многоконтейнерные приложения. 

В отличии от docker вместо запуска каждого контейнера вручную, запускает их всех одним скопом.
Информацию о скорпе контейнеров необходимо указать в docker-compose.yml и запускается одной командой: 
```
docker-compose up -d
```

`-d` - отвечает за запуск в фоновом режиме

Управляет зависимостями, которые также указываются внутри файла настройки и запускает контейнеры в нужном поряде.

Собрать контейнеры можно путём:
```
docker-compose build
```

Остановить контейнеры можно путём:
```
docker-compose down
```

Собрать образы:
```
docker-compose build
```

Посмотреть лог:
```
docker-compose log
```
----
#### Настройка docker-compose.yml
```d
version: 3.1 // Версия контейнера, на данный момент считается не обязательным

services:
	db: 
		container_name: имя контейнера
		image: postgres:14-alpine
		restart: always // Перезапускает контейнер, если возникли ошибки в образе.
		environment: // Переменные, которые необходимо передать при запуске сервиса
			POSTGRES_DB: <имя БД>
			POSTGRES_PASSWORD: <Пароль для входа>
			POSTGRES_INIT_DB: <Доп.паргументы>
		ports:
			- target: 5432
			  published: 5432
	php-fpm:  
		container_name: ${COMPOSE_PROJECT_NAME}-php-fpm // имя контейнера
		user: "1000:1000"  // пользователь в linux
		build:  // подгружаем уже готовый dockerFile
		    context: ./../  //контекст - лучше указывать общую папку app для того чтобы подтянуть все возможные файлы внутри контекста
		    dockerfile: ./docker/php/fpm/Dockerfile  // ссылка на докер файл
		volumes:  // прописываем тома (локальные данные)
		  - type: bind  
	      source: ./../app/  // папка, в которой происходят изменения
	      target: /var/www/html/  // папка, куда грузятся изменения в контейнер
		env_file: ./../app/.env.test // окружение
```

----
В docker-hub есть настройки для docker-compose большинства сервисов.

----
Порядок действий:
I. Описать Dockerfile для каждого сервиса (контейнера). В файла указать:
- Базовый образ (ubuntu, python:3.9, node:16)
- Команды для установки необходимых программ и библиотек
- Команды для копирования файлов в контейнер
- Команду `CMD` или `ENTRYPOINT`, которая указывает что должно выполняться в контейнере после запуска.

II. Описание docker-compose.yml. Указать все сервисы приложения, используя Dockerfile. Для каждого сервиса указать:
- Имя сервиса
- Путь до файла Dockerfile
- Порты, которые нужно открыть для сервиса извне
- Переменные окружения
- Volumes - позволяют синхронизировать файлы между хостом и контейнером
- Зависимости между сервисами

III. Собрать образы путём docker-compose build - читает все Dockerfile, указанные в docker-compose.yml.

IV. Запустить контейнер `docker-compose up -d`. Флаг `-d` запускает контейнеры в фоновом режиме.

----
`Volumes` — это выделенные места на диске, которые существуют независимо от файловой системы образа контейнера. Даже если ты удалишь контейнер, данные в volume сохранятся. Это очень важно для сохранения данных, конфигураций, и результатов работы приложения.

volumes нужны для:
1. **Сохранение данных вне контейнера**. Если приложение сохраняет данные (логи, бд, файлы), то можно настроить сохранение данных вне контейнера. даже при удалении контейнера - эти данные сохранятся.
2. **Обмен данными между контейнерами**. Можно настроить volume, который будет доступен нескольким контейнерам. Помогает контейнерам обмениваться данными, не передавая данные по сети.
3. **Синхронизация с хост-машиной**. Настроить локальную папку, которая будет видна контейнеру и любые в ней изменения. Меняешь код - контейнер видит это.